frecuencias_ui <- function(id) {
  ns <- NS(id)
  
  tagList(
    fluidRow(
      box(
        width = 3,
        checkboxInput(
          inputId = ns("episodios_enable"),
          label = "Agrupar por episodios",
          value = F
        ),
        uiOutput(
          outputId = ns("episodios_col_valor_out")
        ),  
        selectizeInput(
          inputId = ns("agrupador_cols"),
          label = "Agrupar por:",
          choices = NULL, 
          multiple = FALSE),
        tags$br(),
        uiOutput(
          outputId = ns("episodios_jerarquia")
        ),
        tags$br(),
        actionButton(ns("frecuencias_exe"), "Confirmar"),
        tags$br(),
        tags$br(),
        downloadButton(
          outputId = ns("frecuencias_descargar_csv"),
          label = "CSV",
          style = "width:100%;"),
        tags$br(),
        tags$br(),
        downloadButton(
          outputId = ns("frecuencias_descargar_xlsx"),
          label = "Excel",
          style = "width:100%;")),
      box(
        width = 9,
        tabsetPanel(
          tabPanel(
            title = "Tabla",
            tags$br(),
            tags$h2(textOutput(ns("tabla_titulo")), class = "titulo_center"),
            tags$br(),
            div(
              DT::dataTableOutput(outputId = ns("frecuencias_tabla")) %>%
                withSpinner(),
              style = "font-size:90%")
          )
        )
      )
    )
  )
}

frecuencias_server <- function(id, opciones) {
  moduleServer(
    id = id,
    module = function(input, output, session) {
      
      ns <- NS(id)
      
      frecuencias <- reactiveValues(
        tabla = data.table(),
        agrupadores_items = NULL)
      
      observeEvent(opciones$colnames, {
        if (input$episodios_enable) {
          updateSelectizeInput(
            session = session,
            inputId = "episodios_col_valor",
            choices = opciones$colnames,
            selected = "nro_identificacion"
          )
        }
        updateSelectizeInput(
          session = session,
          inputId = "agrupador_cols",
          choices = opciones$colnames
        )
      })
      
      observeEvent(input$episodios_enable, {
        if (input$episodios_enable) {
          output$episodios_col_valor_out <- renderUI({
            selectizeInput(
              inputId = ns("episodios_col_valor"),
              label = "Sumar valor por:",
              choices = opciones$colnames,
              selected = "nro_identificacion",
              multiple = FALSE)
          })
        } else {
          output$episodios_col_valor_out <- renderUI({})
        }
      })
      
      cambio_columnas <- reactive({
        list(input$agrupador_cols, input$episodios_enable)
      })
      
      observeEvent(cambio_columnas(), {
        if (!is.null(opciones$colnames) && 
            input$agrupador_cols != "") {
          tryCatch(
            expr = {
              agrupadores_items_length <- opciones$tabla %>%
                select(!!as.name(input$agrupador_cols)) %>%
                distinct() %>%
                transmute(count = n()) %>%
                distinct() %>%
                collect() %>%
                unlist()
              if (agrupadores_items_length <= 60 &&
                  input$episodios_enable) {
                agrupadores_items <- opciones$tabla %>%
                  select(!!as.name(input$agrupador_cols)) %>%
                  distinct() %>%
                  collect() %>%
                  as.list()
                frecuencias$agrupadores_items <- agrupadores_items[[1]]
                print(frecuencias$agrupadores_items)
                output$episodios_jerarquia <- renderUI({
                  descriptiva_jerarquia(
                    ns = ns,
                    items_nivel_4 = frecuencias$agrupadores_items
                  )
                })
              } else {
                frecuencias$agrupadores_items <- NULL
                output$episodios_jerarquia <- renderUI({
                  radioButtons(
                    inputId = ns("descriptiva_unidades"),
                    label = "Unidad de descriptiva",
                    selected = frecuencias$unidad_descriptiva,
                    choiceNames = c(
                      "PrestaciÃ³n",
                      "Paciente",
                      "Factura"
                    ),
                    choiceValues = c(
                      "prestacion",
                      "nro_identificacion",
                      "nro_factura"
                    )
                  )
                })
                frecuencias$unidad_descriptiva <- input$descriptiva_unidades
              }
            },
            error = function(e) {
              print(e)
              sendSweetAlert(
                session = session,
                title = "Error", 
                type = "error",
                text = "Por favor revisar los parametros de carga de datos,
                    columnas, formato de fecha y los datos. Si este problema persiste
                    ponerse en contacto con un administrador."
              )
            }
          )
        }
      })
      
      observeEvent(input$seleccionar_episodio, {
        output$episodios_jerarquia <- renderUI({
          tagList(
            descriptiva_jerarquia(
              ns = ns,
              items_nivel_1 = frecuencias$agrupadores_items)
          )
        })
      })
      
      observeEvent(input$seleccionar_factura, {
        output$episodios_jerarquia <- renderUI({
          tagList(
            descriptiva_jerarquia(
              ns = ns,
              items_nivel_2 = frecuencias$agrupadores_items)
          )
        })
      })
      
      observeEvent(input$seleccionar_paciente, {
        output$episodios_jerarquia <- renderUI({
          tagList(
            descriptiva_jerarquia(
              ns = ns,
              items_nivel_3 = frecuencias$agrupadores_items)
          )
        })
      })
      
      observeEvent(input$seleccionar_prestacion, {
        output$episodios_jerarquia <- renderUI({
          tagList(
            descriptiva_jerarquia(
              ns = ns,
              items_nivel_4 = frecuencias$agrupadores_items)
          )
        })
      })
      
      
      observeEvent(input$frecuencias_exe, {
        
        if(!is.null(opciones$colnames)) {
          if(!is.null(input$agrupador_cols) &&
             input$agrupador_cols != "") {
            tryCatch(
              expr = {
                agrupador_cols <- input$agrupador_cols
                if (input$episodios_enable) {
                  episodios_col_valor <- input$episodios_col_valor
                }
                withProgress(message = "Calculando descriptiva...",{
                  if (!is.null(frecuencias$agrupadores_items)) {
                    frecuencias$descriptiva_basica <- descriptiva_basica_jerarquia(
                      data = opciones$tabla,
                      columnas =      agrupador_cols, 
                      columna_valor = opciones$valor_costo, 
                      columna_suma =  episodios_col_valor,
                      nivel_1 = input$episodios_jerarquia_nivel_1_order,
                      nivel_2 = input$episodios_jerarquia_nivel_2_order,
                      nivel_3 = input$episodios_jerarquia_nivel_3_order,
                      nivel_4 = input$episodios_jerarquia_nivel_4_order)
                  } else {
                    frecuencias$descriptiva_basica <- descriptiva_basica(
                      data = opciones$tabla,
                      agrupador = agrupador_cols,
                      columna_valor = opciones$valor_costo,
                      columna_suma = input$descriptiva_unidades,
                      prestaciones = (input$descriptiva_unidades == "prestacion"),
                      columna_fecha = "fecha_prestacion"
                    )
                  }
                  
                  frecuencias$tabla <- descriptiva_basica_trans(
                    data = frecuencias$descriptiva_basica,
                    agrupador = agrupador_cols,
                    suma = FALSE
                  )
                  
                  frecuencias$tabla[is.na(frecuencias$tabla)] <- 0
                  
                  output$tabla_titulo <- renderText({
                    paste(
                      "Frecuencias de",
                      agrupador_cols,
                      collapse = " "
                    )
                  })
                  
                })
              },
              error = function(e) {
                print(e)
                sendSweetAlert(
                  session = session,
                  title = "Error", 
                  type = "error",
                  text = "Por favor revisar los parametros de carga de datos,
                    columnas, formato de fecha y los datos. Si este problema persiste
                    ponerse en contacto con un administrador."
                )
              }
            )
          }
        }
      })
      
      output$frecuencias_tabla <- DT::renderDataTable({
        if (nrow(frecuencias$tabla) > 0) {
          DT::datatable(
            frecuencias$tabla,
            options = list(
              language = list(
                url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json'),
              pageLength = 50,
              autoWidth = FALSE,
              ordering=T, 
              scrollX = TRUE,
              scrollY = "60vh"),
            rownames= FALSE) %>%
            DT::formatRound(
              2:ncol(frecuencias$tabla),
              mark = ".",
              dec.mark = ",",
              digits = 0)
        }
      })
      
      output$frecuencias_descargar_csv <- downloadHandler(
        filename = function() {
          paste("Frecuencias",
                ".csv", sep="")
        },
        content = function(file) {
          write.csv(
            x = frecuencias$tabla,
            file = file, 
            row.names = FALSE,
            na="")
        }, 
        contentType = "text/csv"
      )
      
      output$frecuencias_descargar_xlsx <- downloadHandler(
        filename = function() {
          paste("Frecuencias",
                ".xlsx", sep="")
        },
        content = function(file) {
          write_xlsx(
            x = frecuencias$tabla,
            path = file)
        }, 
        contentType = "xlsx"
      )
  
  })
}